
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() 
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }
    
    function getUser(userId) {
      return get(/databases/$(database)/documents/users/$(userId));
    }

    function isUserStatus(userId, status) {
        let user = getUser(userId);
        return user != null && user.data.status == status;
    }

    function isActiveUser(userId) {
        return isUserStatus(userId, 'ACTIVE');
    }
    
    function isEmailVerified(userId) {
      let user = getUser(userId);
      return user != null && user.data.emailVerified == true;
    }

    function isStoreOwner(storeId) {
      let store = get(/databases/$(database)/documents/storefronts/$(storeId));
      return store != null && isUser(store.data.ownerUid);
    }
    
    function isOrderParticipant(order) {
      return isSignedIn() && (isUser(order.buyerUid) || isUser(order.sellerUid));
    }
    
    function isOrderBuyer(orderId) {
        let order = get(/databases/$(database)/documents/orders/$(orderId)).data;
        return order != null && isUser(order.buyerUid);
    }
    
    function isConversationParticipant(conversation) {
        return isSignedIn() && request.auth.uid in conversation.participantUids;
    }
    
    // --- Data Validation Helpers ---
    
    // On listing create/update, check if user is allowed to make it active.
    function isValidListingWrite() {
      let isCreatingActive = request.resource.data.state == 'ACTIVE';
      // Only active, email-verified users can create active listings
      let canCreateActive = isActiveUser(request.auth.uid) && isEmailVerified(request.auth.uid);
      // Allow if not creating an active listing, OR if user is permitted to.
      return !isCreatingActive || canCreateActive;
    }
    
    // Checks valid state transitions for an order update.
    function isValidOrderUpdate(existingOrder, newOrder) {
        // Buyer can mark as payment sent if they are providing a shipping address.
        let isBuyerSendingPayment = isUser(existingOrder.buyerUid)
                                  && existingOrder.state == 'PENDING_PAYMENT' 
                                  && newOrder.state == 'PAYMENT_SENT'
                                  && newOrder.buyerShippingAddress != null;
        
        // Seller can mark as shipped if they provide a tracking number.
        let isSellerShipping = isUser(existingOrder.sellerUid)
                               && existingOrder.state == 'PAYMENT_SENT'
                               && newOrder.state == 'SHIPPED'
                               && newOrder.trackingNumber != null;
        
        // Seller can mark as delivered
        let isSellerDelivering = isUser(existingOrder.sellerUid)
                                 && existingOrder.state == 'SHIPPED'
                                 && newOrder.state == 'DELIVERED';

        // Buyer can mark as complete
        let isBuyerCompleting = isUser(existingOrder.buyerUid)
                                && existingOrder.state == 'DELIVERED'
                                && newOrder.state == 'COMPLETED';

        // Any participant can cancel before it's shipped.
        let isCancelling = newOrder.state == 'CANCELLED' && existingOrder.state in ['PENDING_PAYMENT', 'PAYMENT_SENT'];

        return isBuyerSendingPayment || isSellerShipping || isSellerDelivering || isBuyerCompleting || isCancelling;
    }


    // --------------------------------
    // Collection Rules
    // --------------------------------

    // Global deny-all for reads/writes unless explicitly allowed by a sub-rule.
    // This is safer than a global allow.
    match /{path=**} {
      allow read, write: if false;
    }

    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn(); // For mentions, searches, etc.
      
      // Allow user creation if the doc ID matches the user's UID.
      allow create: if isUser(userId);
      
      // A user can update their own doc, but cannot change their role or status.
      // Admins can update anything.
      allow update: if (isUser(userId) 
                      && request.resource.data.role == resource.data.role
                      && request.resource.data.status == resource.data.status)
                      || isAdmin();
                      
      // Subcollections are owned by the user.
      match /notifications/{notificationId} {
        allow read, write: if isUser(userId);
      }
      match /watchlist/{listingId} {
        allow read, write: if isUser(userId);
      }
      match /favoriteStores/{storeId} {
        allow read, write: if isUser(userId);
      }
    }

    match /storefronts/{storeId} {
      allow get, list: if isSignedIn();
      allow create: if isUser(request.resource.data.ownerUid);
      allow update: if isStoreOwner(storeId) || isAdmin();
      
      match /reviews/{reviewId} {
          allow get, list: if isSignedIn();
          // The buyer of the corresponding order can create one review.
          allow create: if isOrderBuyer(request.resource.data.orderId)
                        && !existsAfter(/databases/$(database)/documents/storefronts/$(storeId)/reviews/$(request.resource.data.orderId));
          // Reviews are immutable by users.
          allow update, delete: if isAdmin();
      }
    }
    
    match /listings/{listingId} {
      allow get, list: if isSignedIn();
      allow create: if isUser(request.resource.data.ownerUid) && isValidListingWrite();
      allow update: if isUser(resource.data.ownerUid) && isValidListingWrite();
      allow delete: if isUser(resource.data.ownerUid) || isAdmin();
    }

    match /orders/{orderId} {
      allow get: if isOrderParticipant(resource.data) || isAdmin();
      allow create: if isUser(request.resource.data.buyerUid) && isActiveUser(request.auth.uid);
      allow update: if (isOrderParticipant(resource.data) && isValidOrderUpdate(resource.data, request.resource.data)) || isAdmin();
    }
    
    match /communityMessages/{messageId} {
        allow read: if isSignedIn();
        // Only ACTIVE users can write new messages.
        allow create, update, delete: if isActiveUser(request.auth.uid);
    }

    match /iso24Posts/{isoId} {
        allow get, list: if isActiveUser(request.auth.uid);
        // Only ACTIVE users can create posts.
        allow create: if isUser(request.resource.data.creatorUid) && isActiveUser(request.auth.uid);
        allow update, delete: if isUser(resource.data.creatorUid) || isAdmin();
    }
    
    match /spotlightSlots/{slotId} {
        allow get, list: if isSignedIn();
        // Only Admins can manage spotlight slots.
        allow create, update, delete: if isAdmin();
    }

    match /conversations/{conversationId} {
      allow get, list, create, update: if isConversationParticipant(resource.data);
      
      match /messages/{messageId} {
        allow get, list: if isConversationParticipant(get(/databases/$(database)/documents/conversations/$(conversationId)).data);
        allow create: if isUser(request.resource.data.senderUid);
        allow update, delete: if false; // Messages are immutable.
      }
    }
    
     match /reports/{reportId} {
        allow create: if isSignedIn();
        // Users can read their own submitted reports.
        allow get: if isUser(resource.data.reporterUid) || isAdmin();
        // Only admins can list, update, or delete reports.
        allow list, update, delete: if isAdmin();
    }

  }
}

    